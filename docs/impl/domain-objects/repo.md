# 实现仓储

## 整存整取

### 什么是仓储对聚合的整存整取？

在领域模块内，从仓储内获取到的聚合，是完整可用的。没存储一个聚合的时候，仓储对象都要保证将这个聚合的信息完成的保存，下次可以完整的取出。

### 为什么要对聚合整存整取？

聚合是一个整体，在语义上不存在存取部分。在编写代码时，我们也不期望用户根据代码上下文判断当前获取的聚合的哪部分能用哪部分不能用，或者哪部分被改动过要被存储。
这样才能让领域模块内部更专注于如何解决领域问题，而不是技术上如何存取这个聚合。

```kotlin
interface DogRepository {
  // 整取
  fun findDogById(id: DogId): Dog

  // 建模的时候确定 DogHead 是 Dog 的一部分，不是一个独立的聚合，因此不能单独取出 DogHead
  fun findDogHeadById(id: DogId): DogHead

  // 整存
  fun save(dog: Dog)

  // 建模的时候确定 DogHead 是 Dog 的一部分，不是一个独立的聚合，因此不能单独存储 DogHead
  fun saveDogHead(id: DogId, head: DogHead)
}
```

### 聚合整存整取成为性能瓶颈怎么办？

有两个办法：

- 不改变模型的前提下技术优化
  - 获取聚合时，通过延迟加载等减少载入数据量，按需载入
  - 保存聚合时，采用脏数据检查等办法，增量更新
- 修改模型，拆分聚合

## 可以按照 id 外的属性查询聚合吗？

可以。除了常规的按照 id 查询聚合，还可以根据需要，按照别的属性查询，比如 `findByName` `findByCode` 等。
